<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soheil OS</title>

  <link rel="icon" type="image/png" href="https://s8.uupload.ir/files/finder_macos_bigsur_icon_190173_8v55.png">
  <link rel="apple-touch-icon" href="https://s8.uupload.ir/files/finder_macos_bigsur_icon_190173_8v55.png">

  <link rel="prefetch" href="safari/start.html">
  <link rel="prefetch" href="safari/sohgle.html">
  <link rel="preconnect" href="https://s8.uupload.ir" crossorigin>

  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

  <style>
    :root{
      --os-bg: url("https://s8.uupload.ir/files/macos-big-sur-apple-layers-fluidic-colorful-wwdc-stock-2880x1800-1455_hxwe.jpg");
      --border: rgba(0,0,0,0.10);
      --shadow: 0 22px 44px rgba(0,0,0,0.22);
      --radius: 12px;
      --dock-h: 88px;
      --menu-h: 28px;

      --mac-arrow: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'%3E%3Cpath d='M6 3l0 22l6-6l4 9l3-1l-4-9l8 0z' fill='%23000'/%3E%3Cpath d='M7.5 5.3l0 16.1l4.4-4.4l1-.9l.5 1.2l3.2 7.5l.9-.4l-3.2-7.5l-.5-1.2l1.3 0l6.2 0z' fill='%23fff' opacity='0.35'/%3E%3C/svg%3E") 1 1;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      overflow:hidden;
      background-image: var(--os-bg);
      background-size: cover;
      background-position: center;
      font-family: "Vazirmatn", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      user-select: none;
      cursor: var(--mac-arrow), default;
    }

    button{ cursor: var(--mac-arrow), pointer; }
    input, textarea{ cursor: text; }
    button, input { font-family: inherit; }

    .menubar{
      position: fixed;
      top:0;
      left:0;
      right:0;
      height: var(--menu-h);
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 14px;
      box-sizing: border-box;
      background: rgba(255,255,255,0.18);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      color: rgba(255,255,255,0.92);
      font-size: 12px;
      z-index: 30000;
    }

    .menu-left{ display:flex; align-items:center; gap:10px; }
    .menu-help{
      border:0;
      background: transparent;
      color: rgba(255,255,255,0.92);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
    }
    .menu-help:active{ background: rgba(255,255,255,0.12); }
    .menu-right{ display:flex; align-items:center; gap:10px; opacity: 0.95; }

    .desktop-icons{
      position: fixed;
      top: calc(var(--menu-h) + 16px);
      right: 18px;
      display:flex;
      flex-direction: column;
      gap: 16px;
      z-index: 1200;
      pointer-events: auto;
    }

    .desktop-icon{
      width: 86px;
      border:0;
      background: transparent;
      color: rgba(255,255,255,0.92);
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 8px;
      padding: 8px 6px;
      border-radius: 10px;
    }
    .desktop-icon:active{ background: rgba(0,0,0,0.10); }
    .desktop-icon img{
      width: 54px;
      height: 54px;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35));
    }
    .desktop-icon span{
      font-size: 12px;
      line-height: 1.2;
      text-align:center;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }

    .dock-wrap{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      z-index: 25000;
      pointer-events: auto;
    }

    .dock{
      height: var(--dock-h);
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 10px 16px;
      border-radius: 20px;
      background: rgba(255,255,255,0.30);
      border: 1px solid rgba(255,255,255,0.22);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: var(--shadow);
    }

    .dock-btn{
      width: 54px;
      height: 54px;
      border: 0;
      border-radius: 14px;
      background: transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      position: relative;
      transition: transform 0.18s cubic-bezier(0.2,0.8,0.2,1);
    }
    .dock-btn:hover{ transform: translateY(-10px) scale(1.08); }
    .dock-btn:active{ transform: translateY(-7px) scale(1.05); }

    .dock-btn img{
      width: 54px;
      height: 54px;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.28));
    }

    .dock-dot{
      position:absolute;
      bottom: -6px;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      display:none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .dock-btn.is-running .dock-dot{ display:block; }

    .window{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      width: 820px;
      height: 540px;
      background: rgba(255,255,255,0.90);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      z-index: 1100;
      will-change: transform, left, top, width, height, opacity, filter;
      touch-action: none;
    }

    .window.is-hidden{ display:none; }

    .window.is-maximized{
      top: calc(var(--menu-h) + 10px);
      left: 14px;
      transform: translate(0,0);
      width: calc(100vw - 28px);
      height: calc(100vh - var(--menu-h) - var(--dock-h) - 44px);
      border-radius: 14px;
    }

    .topbar{
      height: 54px;
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 10px 14px;
      box-sizing: border-box;
      background: rgba(246,246,246,0.86);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      position: relative;
      z-index: 20;
      touch-action: none;
    }

    .traffic{
      display:flex;
      gap: 8px;
      align-items:center;
      z-index: 30;
      pointer-events: auto;
      position: relative;
    }

    .light{
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 0.5px solid rgba(0,0,0,0.12);
      padding: 0;
      margin: 0;
      pointer-events: auto;
      background: transparent;
    }
    .light:active{ filter: brightness(0.92); }
    .light.close{ background:#ff5f57; }
    .light.min{ background:#febc2e; }
    .light.max{ background:#28c840; }

    .title{
      font-size: 13px;
      color: rgba(0,0,0,0.78);
      font-weight: 600;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .address{
      flex: 1;
      height: 32px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.92);
      padding: 0 12px;
      font-size: 13px;
      user-select: text;
    }
    .address:focus{
      outline: none;
      border-color: rgba(0,122,255,0.42);
      box-shadow: 0 0 0 3px rgba(0,122,255,0.14);
    }

    .nav-btn{
      width: 30px;
      height: 30px;
      border-radius: 9px;
      border: 1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.90);
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(0,0,0,0.72);
      font-size: 13px;
    }
    .nav-btn:disabled{ opacity: 0.35; cursor: default; }

    .content{
      flex:1;
      background: rgba(255,255,255,0.92);
      position: relative;
      overflow: hidden;
    }

    iframe.app-frame{
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
      display:block;
      position: relative;
      z-index: 1;
    }

    .finder-layout{
      display:flex;
      height:100%;
      width:100%;
    }

    .finder-side{
      width: 220px;
      background: rgba(238,238,238,0.60);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-right: 1px solid rgba(0,0,0,0.08);
      padding: 10px 10px 10px;
      box-sizing: border-box;
      position: relative;
    }

    .side-section{
      margin-top: 10px;
      font-size: 11px;
      color: rgba(0,0,0,0.45);
      font-weight: 700;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      padding: 0 8px;
    }

    .side-item{
      width: 100%;
      border: 0;
      background: transparent;
      text-align: left;
      padding: 8px 10px;
      border-radius: 8px;
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(0,0,0,0.72);
      font-size: 13px;
    }

    .side-item img{
      width: 18px;
      height: 18px;
      object-fit: contain;
      opacity: 0.92;
    }

    .side-item.is-active{
      background: rgba(0,0,0,0.06);
      color: rgba(0,0,0,0.82);
      font-weight: 600;
    }

    .finder-main{
      flex: 1;
      display:flex;
      flex-direction: column;
      background: rgba(255,255,255,0.92);
      overflow:hidden;
    }

    .finder-toolbar{
      height: 50px;
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 0 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.86);
    }

    .finder-toolbar .path{
      font-size: 13px;
      color: rgba(0,0,0,0.74);
      font-weight: 600;
    }

    .finder-scroll{
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      box-sizing: border-box;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      grid-auto-rows: 150px;
      gap: 12px;
    }

    .item{
      border: 0;
      background: transparent;
      border-radius: 12px;
      padding: 12px 10px;
      display:flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
    }
    .item:hover{ background: rgba(0,122,255,0.10); }
    .item:active{ background: rgba(0,122,255,0.14); }

    .item img{
      width: 56px;
      height: 56px;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.16));
    }

    .item .name{
      font-size: 12px;
      color: rgba(0,0,0,0.82);
      text-align: center;
      line-height: 1.35;
      max-width: 100%;
    }

    .item .sub{
      font-size: 11px;
      color: rgba(0,0,0,0.55);
      text-align:center;
      margin-top: -4px;
    }

    .item.is-disabled{
      opacity: 0.55;
      cursor: default;
    }
    .item.is-disabled:hover{ background: transparent; }

    .empty{
      padding: 40px 10px;
      text-align: center;
      color: rgba(0,0,0,0.55);
      font-size: 13px;
    }

    .help-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:none;
      z-index: 26000;
    }
    .help-overlay.is-open{ display:block; }

    .help-card{
      position: absolute;
      top: 64px;
      left: 18px;
      width: 360px;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .help-head{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      background: rgba(246,246,246,0.86);
      color: rgba(0,0,0,0.78);
      font-weight: 700;
      font-size: 13px;
    }

    .help-close{
      border:0;
      background: rgba(0,0,0,0.06);
      color: rgba(0,0,0,0.72);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .help-close:active{ filter: brightness(0.95); }

    .help-body{
      padding: 14px;
      display:flex;
      gap: 12px;
      align-items: flex-start;
    }

    .help-photo{
      width: 72px;
      height: 72px;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,0.10);
      flex: 0 0 auto;
    }
    .help-photo img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .help-text{
      flex:1;
      color: rgba(0,0,0,0.78);
      font-size: 12.5px;
      line-height: 1.6;
      direction: rtl;
      text-align: right;
    }

    .help-text .name{
      font-weight: 800;
      margin-bottom: 6px;
      font-size: 13px;
    }

    @media (max-width: 720px){
      .window{ width: 94vw; height: 72vh; }
      .finder-side{ width: 190px; }
      .grid{ grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
  </style>
</head>

<body>
  <div class="menubar">
    <div class="menu-left">
      <button class="menu-help" id="helpBtn" type="button">Help</button>
    </div>
    <div class="menu-right">
      <span id="clock">00:00</span>
    </div>
  </div>

  <div class="desktop-icons">
    <button class="desktop-icon" id="desktopBin" type="button" title="Bin">
      <img alt="Bin" src="https://s8.uupload.ir/files/recycle_bin_icon-icons.com_55510_vtjw.png">
      <span>Bin</span>
    </button>
  </div>

  <div class="window" id="finderWin" data-app="finder">
    <div class="topbar" data-drag-handle="finder">
      <div class="traffic">
        <button class="light close" type="button" data-app="finder" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="finder" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="finder" data-action="maximize" aria-label="Maximize"></button>
      </div>
      <div class="title">Finder</div>
    </div>

    <div class="content">
      <div class="finder-layout">
        <div class="finder-side">
          <div class="side-section">Favorites</div>

          <button class="side-item is-active" type="button" data-finder="projects">
            <img alt="Projects" src="https://s8.uupload.ir/files/finder_macos_bigsur_icon_190173_8v55.png">
            Projects
          </button>

          <button class="side-item" type="button" data-finder="desktop">
            <img alt="Desktop" src="https://s8.uupload.ir/files/finder_macos_bigsur_icon_190173_8v55.png">
            Desktop
          </button>

          <button class="side-item" type="button" data-finder="downloads">
            <img alt="Downloads" src="https://s8.uupload.ir/files/finder_macos_bigsur_icon_190173_8v55.png">
            Downloads
          </button>

          <div class="side-section" style="margin-top:14px;">iGithub</div>

          <button class="side-item" type="button" data-finder="igithub">
            <img alt="iGithub" src="https://s8.uupload.ir/files/github_alt_macos_bigsur_icon_190139_sf6w.png">
            iGithub
          </button>
        </div>

        <div class="finder-main">
          <div class="finder-toolbar">
            <div class="path" id="finderPath">Projects</div>
          </div>

          <div class="finder-scroll" id="finderScroll">
            <div id="projectsView">
              <div class="grid" id="projectsGrid"></div>
              <div class="empty" id="projectsEmpty" style="display:none;">No recipes yet</div>
            </div>

            <div id="downloadsView" style="display:none;">
              <div class="empty">Downloads folder is empty</div>
            </div>

            <div id="igithubHint" style="display:none;">
              <div class="empty">iGithub opened as a separate app</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="window is-hidden" id="safariWin" data-app="safari" aria-hidden="true" style="width: 980px; height: 640px;">
    <div class="topbar" data-drag-handle="safari">
      <div class="traffic">
        <button class="light close" type="button" data-app="safari" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="safari" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="safari" data-action="maximize" aria-label="Maximize"></button>
      </div>

      <button class="nav-btn" id="sBack" type="button" aria-label="Back">‹</button>
      <button class="nav-btn" id="sForward" type="button" aria-label="Forward">›</button>
      <button class="nav-btn" id="sReload" type="button" aria-label="Reload">↻</button>

      <input class="address" id="sAddress" type="text" value="Start Page" autocomplete="off" spellcheck="false" />
    </div>

    <div class="content">
      <iframe class="app-frame" id="sFrame" title="Safari"
        src="safari/start.html"
        sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <div class="window is-hidden" id="recipeWin" data-app="recipe" aria-hidden="true" style="width: 980px; height: 640px;">
    <div class="topbar" data-drag-handle="recipe">
      <div class="traffic">
        <button class="light close" type="button" data-app="recipe" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="recipe" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="recipe" data-action="maximize" aria-label="Maximize"></button>
      </div>
      <div class="title" id="recipeTitle">Recipe</div>
      <input class="address" id="recipeAddress" type="text" value="" readonly />
    </div>

    <div class="content">
      <iframe class="app-frame" id="recipeFrame" title="Recipe"
        src="about:blank"
        sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <div class="window is-hidden" id="igithubWin" data-app="igithub" aria-hidden="true" style="width: 980px; height: 640px;">
    <div class="topbar" data-drag-handle="igithub">
      <div class="traffic">
        <button class="light close" type="button" data-app="igithub" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="igithub" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="igithub" data-action="maximize" aria-label="Maximize"></button>
      </div>
      <div class="title">iGithub</div>
    </div>

    <div class="content">
      <iframe class="app-frame" id="igithubFrame" title="iGithub"
        src="igit/igit-index.html"
        sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <div class="window is-hidden" id="musicWin" data-app="music" aria-hidden="true" style="width: 860px; height: 560px;">
    <div class="topbar" data-drag-handle="music">
      <div class="traffic">
        <button class="light close" type="button" data-app="music" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="music" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="music" data-action="maximize" aria-label="Maximize"></button>
      </div>
      <div class="title">Music</div>
    </div>

    <div class="content">
      <iframe class="app-frame" id="musicFrame" title="Music"
        src="music/music-list.html"
        sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <div class="window is-hidden" id="binWin" data-app="bin" aria-hidden="true" style="width: 860px; height: 560px;">
    <div class="topbar" data-drag-handle="bin">
      <div class="traffic">
        <button class="light close" type="button" data-app="bin" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="bin" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="bin" data-action="maximize" aria-label="Maximize"></button>
      </div>
      <div class="title">Bin</div>
    </div>

    <div class="content">
      <iframe class="app-frame" id="binFrame" title="Bin"
        src="bin/index_bin.html"
        sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <div class="window is-hidden" id="desktopWin" data-app="desktop" aria-hidden="true" style="width: 980px; height: 640px;">
    <div class="topbar" data-drag-handle="desktop">
      <div class="traffic">
        <button class="light close" type="button" data-app="desktop" data-action="close" aria-label="Close"></button>
        <button class="light min" type="button" data-app="desktop" data-action="minimize" aria-label="Minimize"></button>
        <button class="light max" type="button" data-app="desktop" data-action="maximize" aria-label="Maximize"></button>
      </div>
      <div class="title">Desktop</div>
    </div>

    <div class="content">
      <iframe class="app-frame" id="desktopFrame" title="Desktop"
        src="desktop/index.html"
        sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
    </div>
  </div>

  <div class="help-overlay" id="helpOverlay" aria-hidden="true">
    <div class="help-card">
      <div class="help-head">
        <span>About</span>
        <button class="help-close" id="helpClose" type="button">Close</button>
      </div>
      <div class="help-body">
        <div class="help-photo">
          <img alt="Soheil" src="https://s8.uupload.ir/files/photo_2026-02-10_18-49-52_fwiq.jpg">
        </div>
        <div class="help-text">
          <div class="name">Soheil OS v1.0.0</div>
          <div>
            این پروژه را ساختم تا دستور پخت غذاهای مختلف را برای مامانم یکجا جمع کنم.
            هدف این بود که دیگر مجبور نباشد بین سایت ها دنبال دستور پخت بگردد.
            همه چیز داخل همین محیط اجرا میشود.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="dock-wrap">
    <div class="dock">
      <button class="dock-btn is-running" id="dockFinder" type="button" title="Finder">
        <img alt="Finder" src="https://s8.uupload.ir/files/finder_macos_bigsur_icon_190173_8v55.png">
        <span class="dock-dot"></span>
      </button>

      <button class="dock-btn" id="dockSafari" type="button" title="Safari">
        <img alt="Safari" src="https://s8.uupload.ir/files/safari_macos_bigsur_icon_189770_ye5.png">
        <span class="dock-dot"></span>
      </button>

      <button class="dock-btn" id="dockMusic" type="button" title="Music">
        <img alt="Music" src="https://s8.uupload.ir/files/apple_music_macos_bigsur_icon_190383_q9sn.png">
        <span class="dock-dot"></span>
      </button>

      <button class="dock-btn" id="dockIGithub" type="button" title="iGithub">
        <img alt="iGithub" src="https://s8.uupload.ir/files/github_alt_macos_bigsur_icon_190139_sf6w.png">
        <span class="dock-dot"></span>
      </button>

      <button class="dock-btn" id="dockSource" type="button" title="Source Code">
        <img alt="Source" src="https://s8.uupload.ir/files/terminal_macos_bigsur_icon_189655_kepj.png">
        <span class="dock-dot"></span>
      </button>
    </div>
  </div>

  <script>
    function updateClock(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      document.getElementById("clock").textContent = hh + ":" + mm;
    }
    updateClock();
    setInterval(updateClock, 1000);

    const state = {
      z: 1100,
      active: "finder",
      safari: { history: ["safari/start.html"], index: 0 },
      finderView: "projects"
    };

    const apps = {
      finder: { key:"finder", el: document.getElementById("finderWin"), dock: document.getElementById("dockFinder"), isOpen:true, isMin:false, busy:false },
      safari:  { key:"safari",  el: document.getElementById("safariWin"),  dock: document.getElementById("dockSafari"),  isOpen:false, isMin:false, busy:false },
      recipe:  { key:"recipe",  el: document.getElementById("recipeWin"),  dock: null, isOpen:false, isMin:false, busy:false },
      igithub: { key:"igithub", el: document.getElementById("igithubWin"), dock: document.getElementById("dockIGithub"), isOpen:false, isMin:false, busy:false },
      music:   { key:"music",   el: document.getElementById("musicWin"),   dock: document.getElementById("dockMusic"), isOpen:false, isMin:false, busy:false },
      bin:     { key:"bin",     el: document.getElementById("binWin"),     dock: null, isOpen:false, isMin:false, busy:false },
      desktop: { key:"desktop", el: document.getElementById("desktopWin"), dock: null, isOpen:false, isMin:false, busy:false }
    };

    function markRunning(appKey){
      const app = apps[appKey];
      if (!app || !app.dock) return;
      if (app.isOpen) app.dock.classList.add("is-running");
      else app.dock.classList.remove("is-running");
    }

    function bringToFront(appKey){
      const app = apps[appKey];
      if (!app) return;
      state.active = appKey;
      state.z += 1;
      app.el.style.zIndex = String(state.z);
    }

    function baseTransform(appEl){
      return appEl.classList.contains("is-maximized") ? "translate(0,0)" : "translate(-50%,-50%)";
    }

    function animateOpen(appEl){
      const base = baseTransform(appEl);
      appEl.style.pointerEvents = "none";
      appEl.animate(
        [
          { opacity: 0, filter: "blur(2px)", transform: base + " scale(0.96)" },
          { opacity: 1, filter: "blur(0px)", transform: base + " scale(1)" }
        ],
        { duration: 220, easing: "cubic-bezier(0.2,0.8,0.2,1)", fill: "forwards" }
      ).finished.finally(() => {
        appEl.style.pointerEvents = "";
        appEl.style.opacity = "";
        appEl.style.filter = "";
        appEl.style.transform = "";
      });
    }

    function animateClose(appEl){
      const base = baseTransform(appEl);
      appEl.style.pointerEvents = "none";
      return appEl.animate(
        [
          { opacity: 1, filter: "blur(0px)", transform: base + " scale(1)" },
          { opacity: 0, filter: "blur(2px)", transform: base + " scale(0.92)" }
        ],
        { duration: 210, easing: "cubic-bezier(0.22,0.61,0.36,1)", fill: "forwards" }
      ).finished.finally(() => {
        appEl.style.pointerEvents = "";
      });
    }

    function animateToDock(appEl, dockEl){
      if (!dockEl) return Promise.resolve();
      const base = baseTransform(appEl);

      const w = appEl.getBoundingClientRect();
      const d = dockEl.getBoundingClientRect();

      const dx = (d.left + d.width/2) - (w.left + w.width/2);
      const dy = (d.top + d.height/2) - (w.top + w.height/2);

      appEl.style.pointerEvents = "none";
      return appEl.animate(
        [
          { opacity: 1, filter: "blur(0px)", transform: base + " translate(0px,0px) scale(1)" },
          { opacity: 0, filter: "blur(2px)", transform: base + " translate(" + dx + "px," + dy + "px) scale(0.08)" }
        ],
        { duration: 300, easing: "cubic-bezier(0.22,0.61,0.36,1)", fill: "forwards" }
      ).finished.finally(() => {
        appEl.style.pointerEvents = "";
      });
    }

    function openApp(appKey){
      const app = apps[appKey];
      if (!app || app.busy) return;

      app.el.classList.remove("is-hidden");
      app.el.setAttribute("aria-hidden","false");
      app.el.style.display = "flex";
      app.isOpen = true;
      app.isMin = false;

      bringToFront(appKey);
      animateOpen(app.el);
      markRunning(appKey);
    }

    function resetSafariState(){
      state.safari.history = ["safari/start.html"];
      state.safari.index = 0;
      const sFrame = document.getElementById("sFrame");
      const sAddress = document.getElementById("sAddress");
      sFrame.src = "safari/start.html";
      sAddress.value = "Start Page";
      safariSetButtons();
    }

    function closeApp(appKey){
      const app = apps[appKey];
      if (!app || !app.isOpen || app.busy) return;

      app.busy = true;
      bringToFront(appKey);

      animateClose(app.el).finally(() => {
        app.el.style.display = "none";
        app.el.classList.add("is-hidden");
        app.el.setAttribute("aria-hidden","true");
        app.el.style.opacity = "";
        app.el.style.filter = "";
        app.el.style.transform = "";
        app.busy = false;

        app.isOpen = false;
        app.isMin = false;
        markRunning(appKey);

        if (appKey === "safari") resetSafariState();
      });
    }

    function minimizeApp(appKey){
      const app = apps[appKey];
      if (!app || !app.isOpen || app.busy) return;

      app.busy = true;
      bringToFront(appKey);

      animateToDock(app.el, app.dock).finally(() => {
        app.el.style.display = "none";
        app.el.classList.add("is-hidden");
        app.el.setAttribute("aria-hidden","true");
        app.el.style.opacity = "";
        app.el.style.filter = "";
        app.el.style.transform = "";
        app.busy = false;

        app.isMin = true;
        markRunning(appKey);
      });
    }

    function restoreApp(appKey){
      const app = apps[appKey];
      if (!app || !app.isOpen || app.busy) return;

      app.el.classList.remove("is-hidden");
      app.el.setAttribute("aria-hidden","false");
      app.el.style.display = "flex";
      app.isMin = false;

      bringToFront(appKey);
      animateOpen(app.el);
      markRunning(appKey);
    }

    function saveWindowInline(appEl){
      appEl.dataset.prevLeft = appEl.style.left || "";
      appEl.dataset.prevTop = appEl.style.top || "";
      appEl.dataset.prevWidth = appEl.style.width || "";
      appEl.dataset.prevHeight = appEl.style.height || "";
      appEl.dataset.prevTransform = appEl.style.transform || "";
    }

    function restoreWindowInline(appEl){
      appEl.style.left = appEl.dataset.prevLeft || "";
      appEl.style.top = appEl.dataset.prevTop || "";
      appEl.style.width = appEl.dataset.prevWidth || "";
      appEl.style.height = appEl.dataset.prevHeight || "";
      appEl.style.transform = appEl.dataset.prevTransform || "";
    }

    function toggleMaximize(appKey){
      const app = apps[appKey];
      if (!app || !app.isOpen || app.busy) return;

      bringToFront(appKey);
      const el = app.el;
      const isMax = el.classList.contains("is-maximized");

      if (!isMax){
        saveWindowInline(el);
        el.style.left = "";
        el.style.top = "";
        el.style.width = "";
        el.style.height = "";
        el.style.transform = "";
        el.classList.add("is-maximized");
        return;
      }

      el.classList.remove("is-maximized");
      restoreWindowInline(el);
      if (!el.style.left && !el.style.top) {
        el.style.transform = "";
      }
    }

    function handleTraffic(appKey, action){
      if (action === "close") closeApp(appKey);
      if (action === "minimize") minimizeApp(appKey);
      if (action === "maximize") toggleMaximize(appKey);
    }

    document.querySelectorAll("button.light[data-app][data-action]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        handleTraffic(btn.dataset.app, btn.dataset.action);
      });
    });

    Object.values(apps).forEach((app) => {
      app.el.addEventListener("pointerdown", () => bringToFront(app.key));
    });

    function bindDock(appKey){
      const app = apps[appKey];
      if (!app || !app.dock) return;

      app.dock.addEventListener("click", () => {
        if (!app.isOpen) { openApp(appKey); return; }
        if (app.isMin) { restoreApp(appKey); return; }
        bringToFront(appKey);
      });
    }

    bindDock("finder");
    bindDock("safari");
    bindDock("music");
    bindDock("igithub");

    document.getElementById("dockSource").addEventListener("click", () => {
      if (!apps.igithub.isOpen) openApp("igithub");
      else if (apps.igithub.isMin) restoreApp("igithub");
      else bringToFront("igithub");
    });

    function makeDraggable(appKey){
      const app = apps[appKey];
      if (!app) return;

      const el = app.el;
      const handle = el.querySelector('[data-drag-handle="' + appKey + '"]');
      if (!handle) return;

      let dragging = false;
      let startX = 0;
      let startY = 0;
      let startLeft = 0;
      let startTop = 0;

      function isInteractiveTarget(target){
        if (!target) return false;
        if (target.closest(".traffic")) return true;
        const tag = target.tagName;
        return tag === "INPUT" || tag === "BUTTON" || tag === "A" || tag === "TEXTAREA" || tag === "SELECT";
      }

      function onMove(e){
        if (!dragging) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        const minLeft = 10;
        const minTop = 44;
        const maxLeft = window.innerWidth - 80;
        const maxTop = window.innerHeight - 80;

        const nextLeft = Math.min(Math.max(minLeft, startLeft + dx), maxLeft);
        const nextTop = Math.min(Math.max(minTop, startTop + dy), maxTop);

        el.style.left = nextLeft + "px";
        el.style.top = nextTop + "px";
      }

      function end(){
        dragging = false;
        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", end);
        window.removeEventListener("pointercancel", end);
      }

      handle.addEventListener("pointerdown", (e) => {
        if (isInteractiveTarget(e.target)) return;
        if (el.classList.contains("is-maximized")) return;

        dragging = true;
        bringToFront(appKey);

        const r = el.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        startLeft = r.left;
        startTop = r.top;

        el.style.left = startLeft + "px";
        el.style.top = startTop + "px";
        el.style.transform = "translate(0,0)";

        window.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", end);
        window.addEventListener("pointercancel", end);

        try { handle.setPointerCapture(e.pointerId); } catch (_) {}
      });
    }

    makeDraggable("finder");
    makeDraggable("safari");
    makeDraggable("recipe");
    makeDraggable("igithub");
    makeDraggable("music");
    makeDraggable("bin");
    makeDraggable("desktop");

    const helpOverlay = document.getElementById("helpOverlay");
    function openHelp(){
      helpOverlay.classList.add("is-open");
      helpOverlay.setAttribute("aria-hidden","false");
    }
    function closeHelp(){
      helpOverlay.classList.remove("is-open");
      helpOverlay.setAttribute("aria-hidden","true");
    }
    document.getElementById("helpBtn").addEventListener("click", openHelp);
    document.getElementById("helpClose").addEventListener("click", closeHelp);
    helpOverlay.addEventListener("click", (e) => {
      if (e.target === helpOverlay) closeHelp();
    });

    document.getElementById("desktopBin").addEventListener("click", () => {
      if (!apps.bin.isOpen) openApp("bin");
      else if (apps.bin.isMin) restoreApp("bin");
      else bringToFront("bin");
    });

    function setFinderActive(view){
      state.finderView = view;

      document.querySelectorAll(".side-item[data-finder]").forEach((b) => {
        b.classList.toggle("is-active", b.getAttribute("data-finder") === view);
      });

      document.getElementById("projectsView").style.display = view === "projects" ? "block" : "none";
      document.getElementById("downloadsView").style.display = view === "downloads" ? "block" : "none";
      document.getElementById("igithubHint").style.display = view === "igithub" ? "block" : "none";

      const pathEl = document.getElementById("finderPath");
      if (view === "projects") pathEl.textContent = "Projects";
      if (view === "downloads") pathEl.textContent = "Downloads";
      if (view === "igithub") pathEl.textContent = "iGithub";
    }

    document.querySelectorAll(".side-item[data-finder]").forEach((b) => {
      b.addEventListener("click", () => {
        const view = b.getAttribute("data-finder");
        bringToFront("finder");

        if (view === "desktop"){
          if (!apps.desktop.isOpen) openApp("desktop");
          else if (apps.desktop.isMin) restoreApp("desktop");
          else bringToFront("desktop");
          return;
        }

        if (view === "igithub"){
          setFinderActive("igithub");
          if (!apps.igithub.isOpen) openApp("igithub");
          else if (apps.igithub.isMin) restoreApp("igithub");
          else bringToFront("igithub");
          return;
        }

        setFinderActive(view);
      });
    });

    async function loadRecipes(){
      const grid = document.getElementById("projectsGrid");
      const empty = document.getElementById("projectsEmpty");
      grid.innerHTML = "";
      empty.style.display = "none";

      try{
        const res = await fetch("recipes/recipes.json", { cache: "no-store" });
        if (!res.ok) throw new Error("recipes.json not reachable");
        const items = await res.json();

        if (!Array.isArray(items) || !items.length){
          empty.style.display = "block";
          return;
        }

        items.forEach((it) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "item";

          const coming = it.coming_soon === true || it.type === "coming_soon";
          if (coming) btn.classList.add("is-disabled");

          const img = document.createElement("img");
          img.alt = it.title_fa || it.title || "Recipe";
          img.src = it.icon || "https://s8.uupload.ir/files/garlic_bread_krr0.png";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = it.title_fa || it.title || "Recipe";

          const sub = document.createElement("div");
          sub.className = "sub";
          sub.textContent = it.subtitle_fa || it.subtitle || it.title_en || "";

          btn.appendChild(img);
          btn.appendChild(name);
          btn.appendChild(sub);

          if (!coming){
            btn.addEventListener("click", () => openRecipe(it));
          }

          grid.appendChild(btn);
        });
      } catch (e){
        empty.style.display = "block";
      }
    }

    function openRecipe(it){
      const title = it.title_fa || it.title || "Recipe";
      const url = it.url || "";
      if (!url) return;

      document.getElementById("recipeTitle").textContent = title;
      document.getElementById("recipeAddress").value = url;
      document.getElementById("recipeFrame").src = url;

      if (!apps.recipe.isOpen) openApp("recipe");
      else if (apps.recipe.isMin) restoreApp("recipe");
      else bringToFront("recipe");
    }

    loadRecipes();

    const sFrame = document.getElementById("sFrame");
    const sAddress = document.getElementById("sAddress");
    const sBack = document.getElementById("sBack");
    const sForward = document.getElementById("sForward");
    const sReload = document.getElementById("sReload");

    function safariSetButtons(){
      sBack.disabled = state.safari.index <= 0;
      sForward.disabled = state.safari.index >= state.safari.history.length - 1;
    }
    safariSetButtons();

    function safariResolve(input){
      const raw = String(input || "").trim();
      const low = raw.toLowerCase();

      if (!raw || low === "start" || low === "start page" || low === "new tab") return "safari/start.html";
      if (low === "sohgle" || low === "google" || low.includes("google.")) return "safari/sohgle.html";
      if (low.startsWith("sohgle?") || low.startsWith("sohgle.html")) return "safari/sohgle.html" + (raw.includes("?") ? raw.slice(raw.indexOf("?")) : "");

      if (raw.startsWith("safari/") || raw.startsWith("recipes/") || raw.startsWith("music/") || raw.startsWith("igit/") || raw.startsWith("desktop/") || raw.startsWith("bin/") || raw.startsWith("garlic-bread/")) return raw;

      return "safari/sohgle.html?q=" + encodeURIComponent(raw);
    }

    function safariGo(input, push){
      const url = safariResolve(input);

      if (push){
        const cur = state.safari.history[state.safari.index];
        if (cur !== url){
          state.safari.history = state.safari.history.slice(0, state.safari.index + 1);
          state.safari.history.push(url);
          state.safari.index = state.safari.history.length - 1;
        }
      }

      sFrame.src = url;
      sAddress.value = (url === "safari/start.html") ? "Start Page" : url;
      safariSetButtons();
    }

    function openSafari(target){
      if (!apps.safari.isOpen) openApp("safari");
      else if (apps.safari.isMin) restoreApp("safari");
      else bringToFront("safari");

      safariGo(target || "start", true);
    }

    document.getElementById("dockSafari").addEventListener("click", () => {
      if (!apps.safari.isOpen) openSafari("start");
      else if (apps.safari.isMin) restoreApp("safari");
      else bringToFront("safari");
    });

    sAddress.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      safariGo(sAddress.value, true);
      sAddress.blur();
    });

    sBack.addEventListener("click", () => {
      if (state.safari.index <= 0) return;
      state.safari.index -= 1;
      const url = state.safari.history[state.safari.index];
      sFrame.src = url;
      sAddress.value = (url === "safari/start.html") ? "Start Page" : url;
      safariSetButtons();
    });

    sForward.addEventListener("click", () => {
      if (state.safari.index >= state.safari.history.length - 1) return;
      state.safari.index += 1;
      const url = state.safari.history[state.safari.index];
      sFrame.src = url;
      sAddress.value = (url === "safari/start.html") ? "Start Page" : url;
      safariSetButtons();
    });

    sReload.addEventListener("click", () => {
      const url = state.safari.history[state.safari.index] || "safari/start.html";
      sFrame.src = url;
    });

    window.addEventListener("message", (event) => {
      const d = event.data;
      if (!d || typeof d !== "object") return;

      if (d.type === "os:openApp"){
        const app = d.app || "";
        if (app === "safari") openSafari(d.url || "start");
        if (app === "igithub") {
          if (!apps.igithub.isOpen) openApp("igithub");
          else if (apps.igithub.isMin) restoreApp("igithub");
          else bringToFront("igithub");
        }
        if (app === "music") {
          if (!apps.music.isOpen) openApp("music");
          else if (apps.music.isMin) restoreApp("music");
          else bringToFront("music");
        }
        if (app === "bin") {
          if (!apps.bin.isOpen) openApp("bin");
          else if (apps.bin.isMin) restoreApp("bin");
          else bringToFront("bin");
        }
        if (app === "desktop") {
          if (!apps.desktop.isOpen) openApp("desktop");
          else if (apps.desktop.isMin) restoreApp("desktop");
          else bringToFront("desktop");
        }
        if (app === "recipe"){
          if (d.recipe) openRecipe(d.recipe);
          else if (d.url){
            openRecipe({ title_fa: d.title || "Recipe", url: d.url, icon: d.icon || "" });
          }
        }
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      const k = state.active;
      const app = apps[k];
      if (!app || !app.isOpen) return;
      const el = app.el;
      if (el.classList.contains("is-maximized")){
        el.classList.remove("is-maximized");
        restoreWindowInline(el);
      }
    });

    setFinderActive("projects");
    markRunning("finder");
  </script>
</body>
</html>
