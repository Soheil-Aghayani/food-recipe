<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Music Player</title>
  
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>

  <style>
    :root {
      --primary-color: #ff7675;
      --primary-shadow: rgba(255, 118, 117, 0.4);
      /* رنگ‌های گرادینت متحرک */
      --bg-1: #ff9a9e;
      --bg-2: #fecfef;
      --bg-3: #ff9a9e;
    }

    body {
      margin: 0;
      height: 100vh;
      background: transparent; /* رنگ پس‌زمینه کل صفحه */
      font-family: "Vazirmatn", sans-serif;
      overflow: hidden; /* جلوگیری از اسکرول هنگام درگ کردن */
      user-select: none;
    }

    /* انیمیشن برای حرکت گرادینت */
    @keyframes gradientFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* انیمیشن تپش (Pulse) برای سایه */
    @keyframes pulseShadow {
      0% { box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
      50% { box-shadow: 0 25px 60px rgba(0,0,0,0.2); }
      100% { box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
    }

    .player-card {
      width: 340px;
      height: 520px;
      background: #fff;
      border-radius: 30px;
      /* پوزیشن ابسولوت برای قابلیت جابجایی */
      position: absolute; 
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%); /* مرکز چین اولیه */
      
      box-shadow: 0 20px 50px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      
      /* انیمیشن نرم برای سایه */
      transition: box-shadow 0.3s ease;
    }
    
    /* کلاس کمکی وقتی موزیک پخش می‌شود */
    .player-card.playing {
      animation: pulseShadow 2s infinite ease-in-out;
    }

    .top-section {
      flex: 1.5;
      /* گرادینت با زاویه -45 درجه و سایز بزرگتر برای حرکت */
      background: linear-gradient(-45deg, var(--bg-1), var(--bg-2), var(--bg-3), var(--bg-1));
      background-size: 400% 400%;
      /* اجرای انیمیشن حرکت پس‌زمینه */
      animation: gradientFlow 10s ease infinite;
      
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* نشانگر موس برای درگ کردن */
      cursor: grab; 
    }
    
    .top-section:active {
      cursor: grabbing;
    }

    .window-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .win-btn {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.1s;
    }
    .win-btn:active { transform: scale(0.9); }
    .close-btn { background: #ff5f57; }
    .min-btn { background: #febc2e; }
    .max-btn { background: #28c840; }

    .cover-art-container {
      width: 180px;
      height: 180px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* جلوگیری از تداخل با درگ */
    }

    .cover-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none; 
    }
    
    .default-icon {
      font-size: 64px;
      color: #fff;
      display: block;
    }

    .bottom-section {
      flex: 1;
      padding: 20px 30px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: #fff;
    }

    .track-info {
      text-align: center;
      margin-bottom: 25px;
    }
    .track-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .track-artist {
      font-size: 14px;
      color: #888;
      margin-top: 5px;
      font-weight: 500;
    }

    .progress-area {
      width: 100%;
      margin-bottom: 25px;
    }
    .progress-bar {
      height: 6px;
      width: 100%;
      background: #eee;
      border-radius: 10px;
      cursor: pointer;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--primary-color);
      border-radius: 10px;
      position: relative;
      transition: background 1s ease;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      right: -5px;
      top: -3px;
      width: 12px;
      height: 12px;
      background: var(--primary-color);
      border-radius: 50%;
      box-shadow: 0 0 5px var(--primary-shadow);
      opacity: 0; 
      transition: opacity 0.2s;
    }
    .progress-area:hover .progress-fill::after { opacity: 1; }

    .timer {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: #aaa;
      font-weight: 600;
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
    }
    .btn-control {
      background: none;
      border: none;
      cursor: pointer;
      color: #333;
      transition: transform 0.1s;
    }
    .btn-control:active { transform: scale(0.9); }
    .btn-control span { font-size: 30px; color: #555; }

    .play-pause-btn {
      width: 60px;
      height: 60px;
      background: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 20px var(--primary-shadow);
      border: none; 
      outline: none;
      cursor: pointer;
      transition: transform 0.1s, background 1s ease, box-shadow 1s ease;
    }
    .play-pause-btn:active { transform: scale(0.95); }
    
    .play-pause-btn span {
      color: #fff;
      font-size: 32px;
    }

  </style>
</head>
<body>

  <div class="player-card" id="playerWindow">
    <div class="window-controls">
      <div class="win-btn close-btn" onclick="handleWindow('close')"></div>
      <div class="win-btn min-btn" onclick="handleWindow('minimize')"></div>
      <div class="win-btn max-btn" onclick="handleWindow('maximize')"></div>
    </div>

    <div class="top-section" id="dragHeader">
      <div class="cover-art-container">
        <img id="coverImage" class="cover-img" alt="Cover Art" crossorigin="anonymous">
        <span class="material-icons default-icon" id="defaultIcon">music_note</span>
      </div>
    </div>

    <div class="bottom-section">
      <div class="track-info">
        <h2 class="track-title" id="title">Loading...</h2>
        <div class="track-artist" id="artist">Please wait</div>
      </div>

      <div class="progress-area">
        <div class="progress-bar" id="progBar">
          <div class="progress-fill" id="progFill"></div>
        </div>
        <div class="timer">
          <span id="currTime">0:00</span>
          <span id="durTime">0:00</span>
        </div>
      </div>

      <div class="controls">
        <button class="btn-control" id="prevBtn"><span class="material-icons">skip_previous</span></button>
        <button class="play-pause-btn" id="playBtn">
          <span class="material-icons" id="playIcon">play_arrow</span>
        </button>
        <button class="btn-control" id="nextBtn"><span class="material-icons">skip_next</span></button>
      </div>
    </div>
  </div>

  <audio id="audio" src="zero.mp3"></audio>

  <script>
    const playerCard = document.getElementById("playerWindow");
    const dragHeader = document.getElementById("dragHeader");
    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("playBtn");
    const playIcon = document.getElementById("playIcon");
    const progBar = document.getElementById("progBar");
    const progFill = document.getElementById("progFill");
    const currTime = document.getElementById("currTime");
    const durTime = document.getElementById("durTime");
    const titleEl = document.getElementById("title");
    const artistEl = document.getElementById("artist");
    const coverImg = document.getElementById("coverImage");
    const defaultIcon = document.getElementById("defaultIcon");
    
    const colorThief = new ColorThief();

    // --- 1. تنظیمات رنگ و گرادینت متحرک ---
    function applyThemeFromImage(imageElement) {
      try {
        if (imageElement.complete) extractColor(imageElement);
        else imageElement.addEventListener('load', () => extractColor(imageElement));
      } catch (e) { console.log(e); }
    }

    function extractColor(img) {
        const dominantColor = colorThief.getColor(img);
        const palette = colorThief.getPalette(img, 3); // گرفتن 3 رنگ

        // تبدیل آرایه به رشته RGB
        const rgb = (c) => `rgb(${c[0]},${c[1]},${c[2]})`;
        
        const domRGB = rgb(dominantColor);
        const shadowRGB = `rgba(${dominantColor[0]},${dominantColor[1]},${dominantColor[2]}, 0.4)`;
        
        // رنگ‌های پالت برای گرادینت
        const col1 = palette[0] ? rgb(palette[0]) : domRGB;
        const col2 = palette[1] ? rgb(palette[1]) : domRGB;
        const col3 = palette[2] ? rgb(palette[2]) : col1;

        // اعمال به متغیرهای CSS
        document.documentElement.style.setProperty('--primary-color', domRGB);
        document.documentElement.style.setProperty('--primary-shadow', shadowRGB);
        
        // تنظیم گرادینت (3 رنگ مختلف برای ایجاد حرکت زیبا)
        document.documentElement.style.setProperty('--bg-1', col1);
        document.documentElement.style.setProperty('--bg-2', col2);
        document.documentElement.style.setProperty('--bg-3', col3);
    }

    // --- 2. لود متادیتا ---
    function loadMetadata() {
      fetch("zero.mp3")
        .then(res => res.blob())
        .then(blob => {
            jsmediatags.read(blob, {
                onSuccess: function(tag) {
                    const tags = tag.tags;
                    titleEl.textContent = tags.title || "Unknown Title";
                    artistEl.textContent = tags.artist || "Unknown Artist";

                    if (tags.picture) {
                        const data = tags.picture.data;
                        const format = tags.picture.format;
                        let base64String = "";
                        for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                        
                        coverImg.src = `data:${format};base64,${window.btoa(base64String)}`;
                        coverImg.style.display = "block";
                        defaultIcon.style.display = "none";
                        applyThemeFromImage(coverImg);
                    } else {
                        fallbackDefault();
                    }
                },
                onError: fallbackDefault
            });
        })
        .catch(fallbackDefault);
    }
    
    function fallbackDefault() {
        titleEl.textContent = "Zero";
        artistEl.textContent = "Imagine Dragons";
        coverImg.style.display = "none";
        defaultIcon.style.display = "block";
    }

    // --- 3. کنترل پخش ---
    function togglePlay(){
      if (audio.paused){
        audio.play();
        playIcon.textContent = "pause";
        // شروع انیمیشن تپش
        playerCard.classList.add("playing");
      } else {
        audio.pause();
        playIcon.textContent = "play_arrow";
        playerCard.classList.remove("playing");
      }
    }
    playBtn.addEventListener("click", togglePlay);
    
    // آپدیت نوار زمان
    audio.addEventListener("timeupdate", () => {
      if(!audio.duration) return;
      const pct = (audio.currentTime / audio.duration) * 100;
      progFill.style.width = pct + "%";
      const m = Math.floor(audio.currentTime / 60);
      const s = Math.floor(audio.currentTime % 60);
      currTime.textContent = `${m}:${s < 10 ? '0'+s : s}`;
    });
    audio.addEventListener("loadedmetadata", () => {
      const m = Math.floor(audio.duration / 60);
      const s = Math.floor(audio.duration % 60);
      durTime.textContent = `${m}:${s < 10 ? '0'+s : s}`;
    });
    progBar.addEventListener("click", (e) => {
      const width = progBar.clientWidth;
      const clickX = e.offsetX;
      audio.currentTime = (clickX / width) * audio.duration;
    });
    audio.addEventListener("ended", () => {
      playIcon.textContent = "play_arrow";
      progFill.style.width = "0%";
      playerCard.classList.remove("playing");
    });

    // --- 4. قابلیت درگ و جابجایی پنجره (Draggable) ---
    let isDragging = false;
    let initialX, initialY;
    let xOffset = 0, yOffset = 0;

    // شروع درگ
    dragHeader.addEventListener("mousedown", dragStart);
    // پایان درگ
    document.addEventListener("mouseup", dragEnd);
    // حین حرکت
    document.addEventListener("mousemove", drag);

    function dragStart(e) {
      // فقط اگر دکمه‌های پنجره کلیک نشده باشند درگ کن
      if(e.target.classList.contains('win-btn')) return;

      // محاسبه موقعیت اولیه با توجه به اینکه ترنسفرم داریم یا نه
      // چون وقتی درگ میکنیم ترنسفرم رو برمیداریم، باید آفست رو درست حساب کنیم
      
      // اگر اولین بار است، پوزیشن فعلی (که وسط صفحه است) را محاسبه کن
      if (xOffset === 0 && yOffset === 0) {
          const rect = playerCard.getBoundingClientRect();
          // ست کردن مقدار اولیه بر اساس پوزیشن فعلی
          xOffset = rect.left;
          yOffset = rect.top;
      }
      
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;

      if (e.target === dragHeader || dragHeader.contains(e.target)) {
        isDragging = true;
      }
    }

    function dragEnd() {
      initialX = xOffset;
      initialY = yOffset;
      isDragging = false;
    }

    function drag(e) {
      if (isDragging) {
        e.preventDefault();
        
        const currentX = e.clientX - initialX;
        const currentY = e.clientY - initialY;

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, playerCard);
      }
    }

    function setTranslate(xPos, yPos, el) {
      // حذف transform پیش‌فرض (که مرکزچین بود) و اعمال مختصات جدید
      // از top/left استفاده میکنیم که راحت تر باشد
      el.style.transform = "none"; 
      el.style.left = xPos + "px";
      el.style.top = yPos + "px";
    }

    // --- 5. دکمه‌های پنجره ---
    window.handleWindow = function(action) {
      if(action === 'close') {
        playerCard.style.transform = "scale(0)";
        audio.pause();
      } else if (action === 'minimize') {
        playerCard.style.opacity = "0.2";
      } else if (action === 'maximize') {
        playerCard.style.opacity = "1";
      }
    }

    window.addEventListener('DOMContentLoaded', loadMetadata);
  </script>
</body>
</html>